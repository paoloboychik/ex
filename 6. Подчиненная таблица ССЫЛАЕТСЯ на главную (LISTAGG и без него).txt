/*Подчиненная таблица ссылается на главную*/
WITH pod AS (
    SELECT t1.table_name || ' (' || constraint_name || ' ' || '(' ||
    LISTAGG(t2.column_name, ', ') WITHIN GROUP (ORDER BY t2.column_name) OVER(PARTITION BY constraint_name) || ') ' as pod,
    t1.r_constraint_name as main_cons
    FROM user_constraints t1 LEFT OUTER JOIN user_cons_columns t2 USING (constraint_name)
    WHERE t1.constraint_type = 'R'
),

glav AS (
    SELECT t1.table_name || ' / ' || constraint_name || ' (' ||
    LISTAGG(t2.column_name, ', ') WITHIN GROUP (ORDER BY t2.column_name) OVER(PARTITION BY constraint_name) || '))' as glav,
    constraint_name as cons
    FROM user_constraints t1 LEFT OUTER JOIN user_cons_columns t2 USING (constraint_name)
)  

SELECT DISTINCT t1.pod || 'ссылается на ' || t2.glav as res
FROM pod t1 LEFT OUTER JOIN glav t2 ON (t1.main_cons = t2.cons)
ORDER BY res;


/*Подчиненные таблицы без LISTAGGA*/
WITH pod AS (
    SELECT t1.table_name, constraint_name, t2.column_name, t1.r_constraint_name
    FROM user_constraints t1 LEFT OUTER JOIN user_cons_columns t2 USING (constraint_name)
    WHERE t1.constraint_type = 'R'
    ORDER BY t1.table_name
),

pod_num_cols AS (
    SELECT l.table_name, l.constraint_name, l.column_name, l.r_constraint_name, COUNT(r.column_name) + 1 as col_num
    FROM pod l LEFT OUTER JOIN pod r
    ON (l.table_name = r.table_name AND l.constraint_name=r.constraint_name 
    AND l.column_name < r.column_name)
    GROUP BY l.table_name, l.constraint_name, l.column_name, l.r_constraint_name
    ORDER BY l.table_name
),
pod_listed AS (
    SELECT table_name || ' (' || constraint_name || ' (' || LTRIM(SYS_CONNECT_BY_PATH(column_name, ', '), ', ') || ') ' as pod,
    r_constraint_name as main_cons
    FROM pod_num_cols
    WHERE CONNECT_BY_ISLEAF = 1
    START WITH col_num = 1
    CONNECT BY PRIOR col_num = col_num -1 AND PRIOR table_name = table_name
    AND PRIOR constraint_name = constraint_name
),
glav AS (
    SELECT t1.table_name, constraint_name, t2.column_name
    FROM user_constraints t1 LEFT OUTER JOIN user_cons_columns t2 USING(constraint_name)
    ORDER BY t1.table_name
),
glav_num_cols AS (
    SELECT l.table_name, l.constraint_name, l.column_name, COUNT(r.column_name) + 1 as col_num
    FROM glav l LEFT OUTER JOIN glav r
    ON (l.table_name = r.table_name AND l.constraint_name = r.constraint_name AND l.column_name < r.column_name)
    GROUP BY l.table_name, l.constraint_name, l.column_name
    ORDER BY l.table_name
),
glav_listed AS (
    SELECT table_name || ' / ' || constraint_name || ' (' || LTRIM(SYS_CONNECT_BY_PATH(column_name, ', '), ', ') || ') ' as glav,
    constraint_name as cons
    FROM glav_num_cols
    WHERE CONNECT_BY_ISLEAF = 1
    START WITH col_num = 1
    CONNECT BY PRIOR col_num = col_num -1 AND PRIOR table_name = table_name
    AND PRIOR constraint_name = constraint_name
)
SELECT DISTINCT t1.pod || 'ссылается на ' || t2.glav as res
FROM pod_listed t1 LEFT OUTER JOIN glav_listed t2 ON (t1.main_cons = t2.cons)
ORDER BY res;